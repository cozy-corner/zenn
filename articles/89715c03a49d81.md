---
title: "BigQuery ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã‚’è©¦ã—ã¦ã¿ãŸ - SQLã€Pandasã¨ã®æ¯”è¼ƒã§ç†è§£ã™ã‚‹"
emoji: "ğŸ›¸"
type: "tech"
topics:
  - "sql"
  - "pandas"
  - "bigquery"
published: true
published_at: "2025-08-01 23:23"
---

## 1. ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã¨ã¯

BigQueryã®æ–°ã—ã„ã‚¯ã‚¨ãƒªæ§‹æ–‡ã€‚ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®æµã‚Œã‚’ä¸Šã‹ã‚‰ä¸‹ã¸ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ï¼ˆ`|>`ï¼‰ã§ç¹‹ã„ã§è¨˜è¿°ã—ã€å‡¦ç†é †åºãŒæ˜ç¢ºã€‚

Google Cloudã®å…¬å¼ãƒ–ãƒ­ã‚°ã€Œ[Exploring pipe syntax: Real world use cases](https://cloud.google.com/blog/ja/products/data-analytics/exploring-pipe-syntax-real-world-use-cases/)ã€ã§ã‚‚è©³ã—ãç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Kaggleã®[UFO Sightings Around the World](https://www.kaggle.com/datasets/camnugent/ufo-sightings-around-the-world)ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã€‚å¾“æ¥ã®SQLã€ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã€Pandasã®3ã¤ã®æ§‹æ–‡ã‚’æ¯”è¼ƒã—ãªãŒã‚‰ã€ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã®åŸºæœ¬ã‚’è§£èª¬ã™ã‚‹ã€‚

æ¯”è¼ƒå¯¾è±¡ã¨ã—ã¦Pandasã‚‚å–ã‚Šä¸Šã’ã‚‹ã€‚Pandasã¯Pythonã®ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€è¡¨å½¢å¼ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œã‚„å‰å‡¦ç†ã«åºƒãä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚ç­†è€…ãŒæ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹éœ€è¦äºˆæ¸¬ã®å‰å‡¦ç†ã§ä½¿ç”¨ã—ãŸçµŒé¨“ãŒã‚ã‚Šã€ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®æµã‚ŒãŒãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã¨ä¼¼ã¦ã„ã‚‹ãŸã‚ã€ç†è§£ã®åŠ©ã‘ã«ãªã‚‹ã¨è€ƒãˆãŸã€‚

## 2. ãƒ‡ãƒ¼ã‚¿é¸æŠãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

### å††ç›¤å‹UFOç›®æ’ƒæƒ…å ±ã®æŠ½å‡º

ã‚¢ãƒ¡ãƒªã‚«ã§ã®å††ç›¤å‹UFOç›®æ’ƒæƒ…å ±ã‚’æŠ½å‡ºã™ã‚‹ä¾‹ã€‚

**å¾“æ¥ã®SQL**
```sql
SELECT 
  Date_time,
  city,
  state_province,
  UFO_shape,
  length_of_encounter_seconds
FROM `your-project-id.ufo_sightings.sightings`
WHERE country = 'us' 
  AND UFO_shape = 'disk'
ORDER BY Date_time DESC
LIMIT 10
```

**ãƒ‘ã‚¤ãƒ—æ§‹æ–‡**
```sql
FROM `your-project-id.ufo_sightings.sightings`
|> WHERE country = 'us' AND UFO_shape = 'disk'
|> SELECT Date_time, city, state_province, UFO_shape, length_of_encounter_seconds
|> ORDER BY Date_time DESC
|> LIMIT 10
```

**Pandas**
```python
result = (df[(df['country'] == 'us') & (df['UFO_shape'] == 'disk')]
         [['Date_time', 'city', 'state_province', 'UFO_shape', 'length_of_encounter_seconds']]
         .sort_values('Date_time', ascending=False)
         .head(10))
```

**æ¯”è¼ƒãƒã‚¤ãƒ³ãƒˆ**
- ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã¨Pandasã¯å‡¦ç†ã®æµã‚ŒãŒä¸Šã‹ã‚‰ä¸‹ã¸é †ç•ªã«è¨˜è¿°
- å¾“æ¥ã®SQLã¯è‹±èªã®æ–‡æ³•çš„ãªæ§‹é€ ï¼ˆSELECT ... FROM ... WHEREï¼‰
- ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã§ã¯å„ã‚¹ãƒ†ãƒƒãƒ—ãŒæ˜ç¢ºã«åˆ†é›¢

### é•·æ™‚é–“ç›®æ’ƒï¼ˆ30åˆ†ä»¥ä¸Šï¼‰ã®ä¾‹

**å¾“æ¥ã®SQL**
```sql
SELECT 
  Date_time,
  city,
  state_province,
  UFO_shape,
  length_of_encounter_seconds / 60 as minutes,
  described_duration_of_encounter
FROM `your-project-id.ufo_sightings.sightings`
WHERE length_of_encounter_seconds >= 1800
  AND country = 'us'
ORDER BY length_of_encounter_seconds DESC
LIMIT 20
```

**ãƒ‘ã‚¤ãƒ—æ§‹æ–‡**
```sql
FROM `your-project-id.ufo_sightings.sightings`
|> WHERE length_of_encounter_seconds >= 1800 AND country = 'us'
|> EXTEND length_of_encounter_seconds / 60 AS minutes
|> ORDER BY length_of_encounter_seconds DESC
|> SELECT Date_time, city, state_province, UFO_shape, minutes, described_duration_of_encounter
|> LIMIT 20
```

**Pandas**
```python
result = (df[(df['length_of_encounter_seconds'] >= 1800) & (df['country'] == 'us')]
         .sort_values('length_of_encounter_seconds', ascending=False)
         .assign(minutes=lambda x: x['length_of_encounter_seconds'] / 60)
         [['Date_time', 'city', 'state_province', 'UFO_shape', 'minutes', 'described_duration_of_encounter']]
         .head(20))
```

ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã§ã¯`EXTEND`æ¼”ç®—å­ã‚’ä½¿ã£ã¦æ–°ã—ã„åˆ—ã‚’è¿½åŠ ã€‚Pandasã®`assign`ãƒ¡ã‚½ãƒƒãƒ‰ã«ç›¸å½“ã€‚

**å®Ÿè¡Œçµæœã®ä¾‹ï¼ˆæœ€åˆã®3è¡Œï¼‰**
| Date_time | city | state_province | UFO_shape | length_of_encounter_seconds |
|---|---|---|---|---|
| 9/9/2012 14:00 | norfolk | va | disk | 30.0 |
| 9/9/2010 00:31 | new york city (manhattan) | ny | disk | 180.0 |
| 9/9/2004 23:00 | kansas city | mo | disk | 5400.0 |

## 3. é›†è¨ˆå‡¦ç†

### UFOå½¢çŠ¶åˆ¥çµ±è¨ˆ

é›†è¨ˆå‡¦ç†ã®ä¾‹ã¨ã—ã¦ã€è¤‡æ•°ã®é›†è¨ˆé–¢æ•°ã‚’ä½¿ç”¨ã€‚

**å¾“æ¥ã®SQL**
```sql
SELECT 
  UFO_shape,
  COUNT(*) as count,
  AVG(length_of_encounter_seconds) as avg_duration,
  MAX(length_of_encounter_seconds) as max_duration,
  MIN(length_of_encounter_seconds) as min_duration
FROM `your-project-id.ufo_sightings.sightings`
WHERE UFO_shape IS NOT NULL
  AND length_of_encounter_seconds IS NOT NULL
GROUP BY UFO_shape
HAVING COUNT(*) >= 1000
ORDER BY count DESC
LIMIT 15
```

**ãƒ‘ã‚¤ãƒ—æ§‹æ–‡**
```sql
FROM `your-project-id.ufo_sightings.sightings`
|> WHERE UFO_shape IS NOT NULL AND length_of_encounter_seconds IS NOT NULL
|> AGGREGATE 
    COUNT(*) as count,
    AVG(length_of_encounter_seconds) as avg_duration,
    MAX(length_of_encounter_seconds) as max_duration,
    MIN(length_of_encounter_seconds) as min_duration
    GROUP BY UFO_shape
|> WHERE count >= 1000
|> ORDER BY count DESC
|> LIMIT 15
```

**Pandas**
```python
result = (df[df['UFO_shape'].notna() & df['length_of_encounter_seconds'].notna()]
         .groupby('UFO_shape')
         .agg({
             'UFO_shape': 'count',
             'length_of_encounter_seconds': ['mean', 'max', 'min']
         })
         .round(2))
result.columns = ['count', 'avg_duration', 'max_duration', 'min_duration']
result = result.reset_index()
result = (result[result['count'] >= 1000]
         .sort_values('count', ascending=False)
         .head(15))
```

**HAVINGã¨WHEREã®é•ã„**

å¾“æ¥ã®SQLã§ã¯é›†è¨ˆå¾Œã®æ¡ä»¶ã«`HAVING`å¥ã‚’ä½¿ç”¨ã€‚ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã§ã¯`WHERE`å¥ã§çµ±ä¸€ã€‚æ§‹æ–‡ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ã€‚

ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã®ç‰¹å¾´ã¨ã—ã¦ã€`WHERE`å¥ã¯ä½•å›ã§ã‚‚ä½¿ç”¨å¯èƒ½ï¼š
- 1å›ç›®ã®`WHERE` - å…ƒãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå¾“æ¥ã®WHEREå¥ï¼‰
- 2å›ç›®ã®`WHERE` - é›†è¨ˆå¾Œã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå¾“æ¥ã®HAVINGå¥ï¼‰
- 3å›ç›®ä»¥é™ã®`WHERE` - ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–¢æ•°å¾Œã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå¾“æ¥ã®QUALIFYå¥ï¼‰ãªã©

**å®Ÿè¡Œçµæœï¼ˆä¸Šä½5å½¢çŠ¶ï¼‰**
| UFO_shape | count | avg_duration | max_duration | min_duration |
|---|---|---|---|---|
| light | 16,565 | 13,170.3 | 66,276,000 | 0.01 |
| triangle | 7,865 | 1,664.3 | 2,631,600 | 0.01 |
| circle | 7,607 | 4,768.1 | 10,526,400 | 0.05 |
| fireball | 6,208 | 4,023.9 | 10,526,400 | 0.01 |
| unknown | 5,874 | 2,970.9 | 5,184,000 | 0.01 |

## 4. ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆï¼ˆå‚è€ƒï¼‰

ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã§ã®JOINè¨˜æ³•ã‚’ç°¡å˜ã«ç´¹ä»‹ã€‚åŸºæœ¬çš„ãªæ§‹æ–‡ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

**å¾“æ¥ã®SQL**
```sql
SELECT t1.col1, t2.col2
FROM table1 t1
JOIN table2 t2 ON t1.id = t2.id
WHERE t1.status = 'active'
```

**ãƒ‘ã‚¤ãƒ—æ§‹æ–‡**
```sql
FROM table1 AS t1
|> JOIN table2 AS t2 ON t1.id = t2.id
|> WHERE t1.status = 'active'
|> SELECT t1.col1, t2.col2
```

**Pandas**
```python
result = (table1[table1['status'] == 'active']
          .merge(table2, on='id', how='inner')
          [['col1', 'col2']])
```

JOINã‚‚ãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ã§ç¹‹ã’ã¦è¨˜è¿°å¯èƒ½ã€‚å‡¦ç†ã®æµã‚ŒãŒä¸Šã‹ã‚‰ä¸‹ã¸ã¨æ˜ç¢ºã«ãªã‚‹ã€‚

## 5. ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–¢æ•°

### å·ã”ã¨ã®UFOç›®æ’ƒä»¶æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°

å„å·ã®ä¸Šä½5éƒ½å¸‚ã‚’æŠ½å‡ºã™ã‚‹ä¾‹ã€‚

**å¾“æ¥ã®SQL**
```sql
SELECT 
  state_province,
  city,
  COUNT(*) as sighting_count,
  RANK() OVER (PARTITION BY state_province ORDER BY COUNT(*) DESC) as city_rank
FROM `your-project-id.ufo_sightings.sightings`
WHERE country = 'us' 
  AND state_province IS NOT NULL 
  AND city IS NOT NULL
GROUP BY state_province, city
QUALIFY city_rank <= 5
ORDER BY state_province, city_rank
```

**ãƒ‘ã‚¤ãƒ—æ§‹æ–‡**
```sql
FROM `your-project-id.ufo_sightings.sightings`
|> WHERE country = 'us' AND state_province IS NOT NULL AND city IS NOT NULL
|> AGGREGATE COUNT(*) as sighting_count GROUP BY state_province, city
|> EXTEND RANK() OVER (PARTITION BY state_province ORDER BY sighting_count DESC) as city_rank
|> WHERE city_rank <= 5
|> ORDER BY state_province, city_rank
```

**Pandas**
```python
# éƒ½å¸‚åˆ¥ã®ç›®æ’ƒä»¶æ•°ã‚’é›†è¨ˆ
city_counts = (df[(df['country'] == 'us') & 
                  df['state_province'].notna() & 
                  df['city'].notna()]
               .groupby(['state_province', 'city'])
               .size()
               .reset_index(name='sighting_count'))

# ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢æ•°ã‚’é©ç”¨
city_counts['city_rank'] = (city_counts.groupby('state_province')['sighting_count']
                            .rank(method='min', ascending=False)
                            .astype(int))

# ä¸Šä½5éƒ½å¸‚ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
result = (city_counts[city_counts['city_rank'] <= 5]
          .sort_values(['state_province', 'city_rank']))
```

ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã§ã¯ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–¢æ•°ã¯`EXTEND`æ¼”ç®—å­ã®ä¸­ã§ä½¿ç”¨ã€‚å¾“æ¥ã®SQLã®`QUALIFY`å¥ã®ä»£ã‚ã‚Šã«`WHERE`å¥ã‚’ä½¿ç”¨ã€‚

**å®Ÿè¡Œçµæœï¼ˆæœ€åˆã®8è¡Œï¼‰**
| state_province | city | sighting_count | city_rank |
|---|---|---|---|
| ak | anchorage | 83 | 1 |
| ak | fairbanks | 48 | 2 |
| ak | wasilla | 23 | 3 |
| ak | north pole | 19 | 4 |
| ak | juneau | 12 | 5 |
| al | birmingham | 54 | 1 |
| al | huntsville | 47 | 2 |
| al | mobile | 23 | 3 |

## 6. å‡¦ç†é †åºã®é•ã„

### å®£è¨€çš„ vs æ‰‹ç¶šãçš„

é›†è¨ˆå‡¦ç†ã‚’ä¾‹ã«ã€å‡¦ç†é †åºã®é•ã„ã‚’ç¢ºèªã€‚

**å¾“æ¥ã®SQL**
```sql
SELECT city, COUNT(*) as count
FROM table
WHERE country = 'us'
GROUP BY city
HAVING COUNT(*) >= 10
ORDER BY count DESC
LIMIT 10
```
å®Ÿè¡Œé †åº: FROM â†’ WHERE â†’ GROUP BY â†’ HAVING â†’ SELECT â†’ ORDER BY â†’ LIMIT

**ãƒ‘ã‚¤ãƒ—æ§‹æ–‡**
```sql
FROM table
|> WHERE country = 'us'
|> AGGREGATE COUNT(*) as count GROUP BY city
|> WHERE count >= 10
|> ORDER BY count DESC
|> LIMIT 10
```
å®Ÿè¡Œé †åº: è¨˜è¿°é †åºã¨åŒã˜ï¼ˆä¸Šã‹ã‚‰ä¸‹ã¸é †æ¬¡å®Ÿè¡Œï¼‰

**Pandas**
```python
(df
 .query("country == 'us'")
 .groupby('city').size()
 .reset_index(name='count')
 .query('count >= 10')
 .sort_values('count', ascending=False)
 .head(10))
```
å®Ÿè¡Œé †åº: è¨˜è¿°é †åºã¨åŒã˜ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã®é †ï¼‰

ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã¨Pandasã¯æ‰‹ç¶šãçš„ãªè¨˜è¿°ã§ã€å‡¦ç†ã®æµã‚ŒãŒç›´æ„Ÿçš„ã€‚ä¸€æ–¹ã€å¾“æ¥ã®SQLã¯å®£è¨€çš„ã§ã€è¨˜è¿°é †åºã¨å®Ÿè¡Œé †åºãŒç•°ãªã‚‹ã€‚

## 7. ã¾ã¨ã‚

### 3ã¤ã®æ§‹æ–‡ã®ç‰¹å¾´

| | å¾“æ¥ã®SQL | ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ | Pandas |
|---|---|---|---|
| è¨˜è¿°ã‚¹ã‚¿ã‚¤ãƒ« | å®£è¨€çš„ | æ‰‹ç¶šãçš„ | æ‰‹ç¶šãçš„ |
| å‡¦ç†ã®æµã‚Œ | è¨˜è¿°é † â‰  å®Ÿè¡Œé † | è¨˜è¿°é † = å®Ÿè¡Œé † | è¨˜è¿°é † = å®Ÿè¡Œé † |
| å¯èª­æ€§ | è¤‡é›‘ãªã‚¯ã‚¨ãƒªã§ã¯è¿½ã„ã«ãã„ | ä¸Šã‹ã‚‰ä¸‹ã¸æ˜ç¢º | ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã§æ˜ç¢º |
| ãƒ‡ãƒãƒƒã‚° | å…¨ä½“ã‚’å®Ÿè¡Œ | é€”ä¸­ã§åˆ‡ã£ã¦ç¢ºèªå¯èƒ½ | é€”ä¸­ã§åˆ‡ã£ã¦ç¢ºèªå¯èƒ½ |

ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã¯ã€ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®æµã‚Œã‚’ç›´æ„Ÿçš„ã«è¡¨ç¾ã§ãã€Pandasãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã‚‚ç†è§£ã—ã‚„ã™ã„æ§‹æ–‡ã€‚BigQueryã§è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚’æ›¸ãéš›ã¯ã€ãƒ‘ã‚¤ãƒ—æ§‹æ–‡ã®åˆ©ç”¨ãŒãŠã™ã™ã‚ã€‚
