# 全国のY字路を地図で探せるサービスを作りました

ふと立ち寄った民間の図書室で[『Y字路はなぜ生まれるのか？』](https://www.amazon.co.jp/dp/4794974450)という本を読んだのがきっかけでした。Y字路巡りが趣味の方がいることを知り、「地図上で効率的に Y字路を探せたら便利では？」と思って作りました。

[OpenStreetMap](https://www.openstreetmap.org/)のデータから抽出した 34,101箇所の Y字路を、地図上で検索・閲覧できるサービスです。

現在、判定精度に課題があります。道路の合流点や交差点など、Y字路ではないものも含まれています。Y字路好きの方々のフィードバックで改善していきたいと考えています。

サービスはこちら: https://storage.googleapis.com/y-junctions-prod-frontend/index.html

![サービスのメイン画面]()

---

## 使い方

### 基本操作

地図を動かすと、その範囲にある Y字路が自動的に表示されます。マーカーをクリックすると詳細情報が表示され、「Street View で見る」ボタンから Google Maps に移動して実際の景色を確認できます。

![マーカーとポップアップ]()

### フィルター機能

左側のフィルターパネルで、次の項目により Y字路を絞り込めます。

- 角度タイプ（超鋭角・鋭角・広角）のチェックボックス
- 最小角度のスライダー

![フィルター操作]()

---

## このサービスでの「Y字路」の定義

### 基本条件

- 3本の道路が接続する交差点
- OpenStreetMap に登録されている道路データを使用
- T字路は除外（最小角度が 60°以上のもの）

### 角度による3つの分類

交差点から各道路への方向を測定し、3つの角度を計算します。このうち最小の角度で次のように分類しています。

| 分類 | 最小角度 | 特徴 |
|------|---------|------|
| 超鋭角 | 30°未満 | 分岐角度が非常に小さい |
| 鋭角 | 30°〜45° | やや鋭い分岐 |
| 広角 | 45°〜60° | 比較的ゆるやかな分岐 |


### 角度の計算方法

このサービスで最も重要なのが、Y字路の角度を正確に計算するロジックです。一見シンプルですが、いくつかの工夫があります。

#### 1. 隣接ノードの選択

まず、Y字路から各道路の「隣接ノード」（次のノード）を取得します。OpenStreetMapでは、道路は現実の交差点やカーブなどの地点（ノード）を複数つないだ線として記録されています。

```
例：ある道路のノードリスト
Way 101: [ノード1, ノード2（Y字路）, ノード3, ノード4, ...]
                            ↓
                     隣接ノードは「ノード3」
```

#### 2. 方位角（Bearing）の計算

次に、Y字路から各隣接ノードへの方位角（コンパスの向き）を計算します。

2つのノード（地点）の緯度・経度から、経度差（東西方向の距離）と緯度差（南北方向の距離）を求め、三角関数を使って「どの方向にあるか」を角度で表現します。

```
Δ経度 = ノード2の経度 - ノード1の経度
Δ緯度 = ノード2の緯度 - ノード1の緯度
方位角 = atan2(Δ経度, Δ緯度) を角度（0°〜360°）に変換
```

atan2は2つの値から角度を計算する三角関数です。結果は0°〜360°の範囲で、北を0°として時計回りに測定されます。時計の短針で考えると分かりやすいです。

- 0° = 北（短針が12時を指す方向）
- 90° = 東（短針が3時を指す方向）
- 180° = 南（短針が6時を指す方向）
- 270° = 西（短針が9時を指す方向）

例：
```
Y字路(35.6812°N, 139.7671°E)から
- 道路A: 隣接ノードが南方向 → 方位角 180°（6時の方向）
- 道路B: 隣接ノードが北寄り → 方位角 345°（11時30分の方向）
- 道路C: 隣接ノードが北寄り → 方位角 15°（12時30分の方向）
```

#### 3. 角度の計算

方位角を時計回りにソートします。これにより、時計回りの順序で隣り合う道路間の角度を正確に計算できます（ソートしないと、例えば15° - 345° = -330°のようにマイナスになってしまいます）。

```
ソート前: [A, B, C] = [180°, 345°, 15°]
ソート後: [C, A, B] = [15°, 180°, 345°]

角度1 = 180° - 15° = 165°
角度2 = 345° - 180° = 165°
角度3 = 360° - 345° + 15° = 30°
                      （1周して最初に戻る）

合計: 165° + 165° + 30° = 360° ✓
```

このうち最小の角度（この例では30°）を使って分類します。この例では最小角度が30°なので「鋭角」のY字路に分類されます。

この方法により、Y字路の形状を正確に捉え、超鋭角・鋭角・広角の3タイプに分類できます。

![3タイプの違い]()

---

## 収録データについて

データソース: [OpenStreetMap](https://www.openstreetmap.org/)
現在の収録範囲: 関東地方
総数: 34,101箇所

### タイプ別の分布

- 広角（normal）：17,386箇所（51.0％）
- 鋭角（sharp）：8,613箇所（25.3％）
- 超鋭角（verysharp）：8,102箇所（23.8％）


### 注意点と現在の課題

私自身は地理も Y字路にも詳しくなく、Y字路ではないものが多く混ざっている可能性が高いです。

現在確認している主な問題：

道路の合流点が含まれている
- 高速道路の合流など、「Y字路」とは言えないものも抽出されています

交差点のようなものが含まれる
- 視覚的には交差点に見えるが、データ上は 3本の道路として記録されているもの

T字路との境界が曖昧
- 60°という閾値が適切かどうか、実際の Y字路と照らし合わせる必要があります

角度計算の精度
- 隣接ノードまでの距離によって、計算される角度の精度が変わる可能性があります（OpenStreetMapのノード間隔は道路によって異なるため）

皆さんのフィードバックで改善したいポイント
- どのような地点は「Y字路ではない」として除外すべきか
- 道路タイプによる絞り込みは有効か（例：高速道路を除外するなど）
- 角度以外の判定基準は必要か

---

## 今後の予定

- 収録範囲の拡大: ニーズがあれば、全国→韓国→台湾と段階的に拡大予定
- その他、皆さんのご意見次第で改善

---

## ご意見をお聞かせください

特に以下の点についてご意見をいただけると嬉しいです：

判定ロジックについて
- 実際に地図を見て「これは Y字路ではない」と思ったものはありますか？
- どのような地点は除外すべきでしょうか？（道路の合流、交差点など）
- 角度の閾値（30°、45°、60°）は適切ですか？

サービスについて
- 使いやすさはどうですか？
- 欲しい機能はありますか？

アンケートは 3分ほどで完了します。

フィードバックを送る:[Google Form の URL]

---

リンク
- サービス: https://storage.googleapis.com/y-junctions-prod-frontend/index.html
- フィードバック:[Google Form の URL]
- 技術的な詳細（GitHub）: https://github.com/cozy-corner/y-junctions
