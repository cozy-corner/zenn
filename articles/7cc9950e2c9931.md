---
title: "JDBIã€Superfluous named parametersã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨å¯¾å‡¦æ³•"
emoji: "ğŸ‘½"
type: "tech"
topics:
  - "java"
  - "kotlin"
  - "db"
  - "jdbc"
published: true
published_at: "2025-08-15 01:35"
---

## ã¯ã˜ã‚ã«

JDBIã§å‹•çš„ã‚¯ã‚¨ãƒªã‚’æ›¸ãéš›ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§`UnableToCreateStatementException: Superfluous named parameters`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

```kotlin
val sql = if (scope == SearchScope.WORLDWIDE) {
    "SELECT * FROM ufo_sightings"
} else {
    "SELECT * FROM ufo_sightings WHERE location_id = :locationId"
}

val query = handle.createQuery(sql)
if (scope == SearchScope.COUNTRY_ONLY) {
    query.bind("locationId", locationId)
}
query.bind("witnessId", witnessId) // å¸¸ã«æœªä½¿ç”¨ã ãŒã€WORLDWIDEæ™‚ã®ã¿ã‚¨ãƒ©ãƒ¼
```

ã“ã®ã‚¨ãƒ©ãƒ¼ã®æŒ™å‹•ãŒé¢ç™½ã‹ã£ãŸã®ã§ã€æ¤œè¨¼ã—ã¦ã¿ã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã§ã¯ã€ã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨å¯¾å‡¦æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚

## ã‚¨ãƒ©ãƒ¼ã®æ­£ä½“

`UnableToCreateStatementException: Superfluous named parameters`ã‚¨ãƒ©ãƒ¼ã¯ã€ä»¥ä¸‹ã®æ¡ä»¶ãŒä¸¡æ–¹æº€ãŸã•ã‚ŒãŸæ™‚ã«ç™ºç”Ÿã—ã¾ã™ï¼š

1. **SQLã‚¯ã‚¨ãƒªã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒå­˜åœ¨ã—ãªã„**
2. **ãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹**

JDBIã®å®Ÿéš›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ï¼ˆ`ArgumentBinder.java`ï¼‰ã‚’è¦‹ã‚‹ã¨ã€ã‚¨ãƒ©ãƒ¼åˆ¤å®šã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ï¼š

```java
void bindNamedCheck(Binding binding, List<String> paramNames) {
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ãŒã€ä½•ã‚‚å®£è¨€ã•ã‚Œã¦ã„ãªã„çŠ¶æ…‹
    boolean argumentsProvidedButNoneDeclared = paramNames.isEmpty() && !binding.isEmpty();
    
    if (argumentsProvidedButNoneDeclared && !ctx.getConfig(SqlStatements.class).isUnusedBindingAllowed()) {
        throw new UnableToCreateStatementException(format(
                "Superfluous named parameters provided while the query "
                        + "declares none: '%s'. This check may be disabled by calling "
                        + "getConfig(SqlStatements.class).setUnusedBindingAllowed(true) "
                        + "or using @AllowUnusedBindings in SQL object.", binding), ctx);
    }
}
```

ã¤ã¾ã‚Šï¼š
- `paramNames.isEmpty()`: SQLã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒãªã„
- `!binding.isEmpty()`: ãƒã‚¤ãƒ³ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹
- `!isUnusedBindingAllowed()`: æœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒ‰ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„

ã“ã®3ã¤ã®æ¡ä»¶ãŒã™ã¹ã¦æº€ãŸã•ã‚ŒãŸæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ç‰¹ã«å‹•çš„ã‚¯ã‚¨ãƒªæ§‹ç¯‰ã§æ¡ä»¶åˆ†å²ãŒã‚ã‚‹å ´åˆã«ã‚ˆãç™ºç”Ÿã—ã¾ã™ã€‚

ã“ã®ã‚±ãƒ¼ã‚¹ã§ã¯`WORLDWIDE`ã®æ™‚ã€SQLã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒãªã„ã®ã«`witnessId`ã‚’ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã„ã‚‹ãŸã‚ã€JDBIãŒã€Œä½¿ã‚ã‚Œãªã„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹ã€ã¨åˆ¤æ–­ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã¾ã™ã€‚

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã‚‚åˆ†ã‹ã‚‹ã‚ˆã†ã«ã€JDBIã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœªä½¿ç”¨ã®ãƒã‚¤ãƒ³ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚

## å®Ÿè¨¼å®Ÿé¨“

å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã€ã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¦ã¿ã¾ã—ãŸï¼š

| SQLãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ | ãƒã‚¤ãƒ³ãƒ‰ | çµæœ | ç†ç”± |
|------------------|--------|------|------|
| ãªã— | ãªã— | âœ… æˆåŠŸ | ä¸¡æ–¹ãªã—ã¯å•é¡Œãªã— |
| ãªã— | ã‚ã‚Š | âŒ **ã‚¨ãƒ©ãƒ¼** | ä»Šå›ã®å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ |
| ã‚ã‚Š | ã‚ã‚Šï¼ˆä½¿ç”¨ï¼‰ | âœ… æˆåŠŸ | æ­£å¸¸ãªãƒ‘ã‚¿ãƒ¼ãƒ³ |
| ã‚ã‚Š | ã‚ã‚Šï¼ˆä¸€éƒ¨æœªä½¿ç”¨ï¼‰ | âœ… æˆåŠŸ | ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒã‚ã‚Œã°ä½™åˆ†ãƒã‚¤ãƒ³ãƒ‰OK |

```kotlin
@Test
fun `should throw exception when binding parameter with no placeholders in SQL`() {
    val exception = assertThrows<UnableToCreateStatementException> {
        jdbi.useHandle<Exception> { handle ->
            // WORLDWIDE: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãªã— + ãƒã‚¤ãƒ³ãƒ‰ã‚ã‚Š = ã‚¨ãƒ©ãƒ¼
            val sql = "SELECT * FROM ufo_sightings"
            val query = handle.createQuery(sql)
            query.bind("witnessId", witnessId)
            query.mapToMap().list()
        }
    }
    
    assert(exception.message?.contains("Superfluous named parameters") == true)
}

@Test
fun `should not throw exception when SQL has placeholders`() {
    assertDoesNotThrow {
        jdbi.useHandle<Exception> { handle ->
            // COUNTRY_ONLY: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚ã‚Š = æˆåŠŸ
            val sql = "SELECT * FROM ufo_sightings WHERE location_id = :locationId"
            val query = handle.createQuery(sql)
            query.bind("locationId", locationId)
            query.bind("witnessId", witnessId) // æœªä½¿ç”¨ã ãŒå•é¡Œãªã—
            query.mapToMap().list()
        }
    }
}
```

**æ„å¤–ãªç™ºè¦‹**ï¼šSQLã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒ1ã¤ã§ã‚‚ã‚ã‚Œã°ã€ä½™åˆ†ãªæœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒ‰ãŒã‚ã£ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã›ã‚“ã€‚JDBIã¯ã€Œãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒå…¨ããªã„SQLã«å¯¾ã—ã¦ãƒã‚¤ãƒ³ãƒ‰ãŒã‚ã‚‹ã€ã‚±ãƒ¼ã‚¹ã®ã¿ã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚

## 3ã¤ã®å¯¾å‡¦æ³•

### 1. ã€æ¨å¥¨ã€‘ä¸è¦ãªãƒã‚¤ãƒ³ãƒ‰ã‚’å‰Šé™¤

æ ¹æœ¬çš„ãªè§£æ±ºæ–¹æ³•ã§ã™ã€‚æ¡ä»¶ã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒ‰ã‚’å‹•çš„ã«è¡Œã„ã¾ã™ï¼š

```kotlin
// Before: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
val query = handle.createQuery(sql)
    .bind("witnessId", witnessId) // ä¸è¦ãªãƒã‚¤ãƒ³ãƒ‰

// After: æˆåŠŸ  
val query = handle.createQuery(sql)
// witnessIdã®ãƒã‚¤ãƒ³ãƒ‰ã‚’å‰Šé™¤
```


### 2. @AllowUnusedBindingsã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

SQL Objectã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å±€æ‰€çš„ã«å¯¾å‡¦ã§ãã¾ã™ï¼š

```kotlin
@RegisterRowMapper(MapMapper::class)
interface UfoQueries {
    @SqlQuery("SELECT * FROM ufo_sightings")
    @AllowUnusedBindings
    fun getAllWithUnusedBinding(@Bind("witnessId") witnessId: String): List<Map<String, Any>>
}
```

### 3. è¨­å®šã§è¨±å¯

`setUnusedBindingAllowed(true)`ã§ä¸€æ‹¬å¯¾å‡¦ï¼š

```kotlin
jdbi.useHandle<Exception> { handle ->
    // è¨­å®šã§ã‚¨ãƒ©ãƒ¼ã‚’ç„¡åŠ¹åŒ–
    handle.configure(SqlStatements::class.java) { 
        it.setUnusedBindingAllowed(true)
    }
    
    val sql = "SELECT * FROM ufo_sightings"
    // æœªä½¿ç”¨ãƒã‚¤ãƒ³ãƒ‰ãŒã‚ã£ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„
    handle.createQuery(sql)
        .bind("witnessId", witnessId)
        .mapToMap().list()
}
```

## ã¾ã¨ã‚

`Superfluous named parameters`ã‚¨ãƒ©ãƒ¼ã¯ã€**SQLã«ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒå…¨ããªã„æ™‚ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã¨ç™ºç”Ÿ**ã—ã¾ã™ã€‚

èˆˆå‘³æ·±ã„ã“ã¨ã«ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒ1ã¤ã§ã‚‚ã‚ã‚Œã°ã€ä½™åˆ†ãªãƒã‚¤ãƒ³ãƒ‰ãŒã‚ã£ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šã€éƒ¨åˆ†çš„ãªãƒã‚¤ãƒ³ãƒ‰ã®æ¬ è½ã¯è¨±å®¹ã•ã‚Œã‚‹è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã¯ã€Œæ˜ã‚‰ã‹ãªãƒŸã‚¹ã€ã ã‘ã‚’ã‚¨ãƒ©ãƒ¼ã«ã—ã¦ã€å‹•çš„ã‚¯ã‚¨ãƒªæ§‹ç¯‰æ™‚ã®æŸ”è»Ÿæ€§ã‚’ç¢ºä¿ã™ã‚‹å®Ÿç”¨çš„ãªåˆ¤æ–­ã ã¨æ€ã‚ã‚Œã¾ã™ãŒã€å³å¯†ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼ã‚’æœŸå¾…ã™ã‚‹å ´åˆã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ãªãŠã€éƒ¨åˆ†çš„ãªæ¬ è½ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹æ¨™æº–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å­˜åœ¨ã—ãªã„ã‚ˆã†ã§ã™ã€‚

## å‚è€ƒ

æ¤œè¨¼ç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ï¼šhttps://github.com/username/jdbi-binding-learning
