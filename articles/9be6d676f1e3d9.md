---
title: "Cloud Run ã§ Cloudâ€¯Profiler ã‚’åˆ©ç”¨ã™ã‚‹"
emoji: "ğŸ”"
type: "tech"
topics:
  - "java"
  - "cloudrun"
  - "googlecloud"
  - "dockerfile"
published: true
published_at: "2025-05-29 00:40"
---

# ã¯ã˜ã‚ã«

Google Cloud ã® [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://cloud.google.com/profiler/docs/about-profiler?hl=ja) ã§ã¯ Cloudâ€¯Profiler ãŒã‚µãƒãƒ¼ãƒˆå¯¾è±¡ã¨ã—ã¦æ˜è¨˜ã•ã‚Œã¦ã„ã‚‹ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã¯ GKEãƒ»GCEãƒ»AppÂ Engine ãªã©ã«é™ã‚‰ã‚Œã€2025â€‘05 æ™‚ç‚¹ã§ Cloudâ€¯Run ã¯ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ãªã„ã€‚ã—ã‹ã—å®Ÿéš›ã«ã¯ JavaÂ Agent ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«åŒæ¢±ã™ã‚Œã° Cloudâ€¯Run ã§ã‚‚ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã§ãã‚‹ã€‚ä»Šå›ã¯ãã®æœ€å°æ‰‹é †ã‚’ã¾ã¨ã‚ã‚‹ã€‚

æ‰‹é †ã®è©³ç´°ã¯[ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/cozy-corner/cloud-profiler-on-cloud-run) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

# Dockerfile â€” ProfilerÂ Agent ã‚’çµ„ã¿è¾¼ã‚€

```dockerfile
FROM gradle:8.5-jdk17 AS build
WORKDIR /app
COPY build.gradle.kts settings.gradle.kts ./
COPY src ./src
RUN gradle build --no-daemon

FROM eclipse-temurin:17-jre
WORKDIR /app
COPY --from=build /app/build/libs/*.jar app.jar

# Cloud Profiler agent
RUN apt-get update && apt-get install -y curl && \
    curl -sSL https://storage.googleapis.com/cloud-profiler/java/latest/profiler_java_agent.tar.gz | tar xz -C /app && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

RUN echo '#!/bin/bash' > /app/start.sh && \
    echo 'exec java -agentpath:/app/profiler_java_agent.so -jar /app/app.jar' >> /app/start.sh && \
    chmod +x /app/start.sh

ENV PORT=8080
EXPOSE 8080
CMD ["/app/start.sh"]
```
## ãƒã‚¤ãƒ³ãƒˆ
- Agent ã® .so ã¨ .jar ã‚’å±•é–‹ã™ã‚‹ã ã‘ã§ OKã€‚ç’°å¢ƒå¤‰æ•°ã¯ä¸è¦ã€‚
- GOOGLE_CLOUD_PROJECT ãªã©ã¯ Cloudâ€¯Run ãŒ è‡ªå‹•ã§ç’°å¢ƒå¤‰æ•°ã«æ³¨å…¥ã™ã‚‹ã€‚ProfilerÂ JavaÂ Agent ã¯ã“ã‚Œã‚’å†…éƒ¨ã§å‚ç…§ã™ã‚‹ãŸã‚ã€DockerfileÂ ã‚„ CMD ã§æ˜ç¤ºã™ã‚‹å¿…è¦ã¯ãªã„ã€‚
- JDKâ€¯17 ä»¥é™ã¯ -XX:+PreserveFramePointer ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœ‰åŠ¹ã€‚

# Cloud Profiler ã§ FlameÂ Graph ã‚’å‡ºã™

test-profiler.shï¼ˆä¸»è¦éƒ¨ï¼‰

CPU è² è·
```bash
for i in {1..10}; do
    curl -s $SERVICE_URL/cpu-intensive > /dev/null
done
```
ãƒ¡ãƒ¢ãƒªè² è·
```bash
for i in {1..10}; do
    curl -s $SERVICE_URL/memory-intensive > /dev/null
done
```
Application.ktï¼ˆæŠœç²‹ï¼‰
```kotlin
fun main() {
    println("Starting application with Cloud Profiler enabled via JVM agent")
    val port = System.getenv("PORT")?.toInt() ?: 8080

    embeddedServer(Netty, port = port) {
        routing {
            get("/") {
                call.respondText("Hello from Cloud Run with Profiler!")
            }
            get("/cpu-intensive") {
                val result = performCpuIntensiveTask()
                call.respondText("CPU intensive task completed: $result")
            }
            get("/memory-intensive") {
                val result = performMemoryIntensiveTask()
                call.respondText("Memory intensive task completed: ${result.size} items")
            }
        }
    }.start(wait = true)
}

fun performCpuIntensiveTask(): Long {
    var sum = 0L
    for (i in 1..10_000_000) {
        sum += i * i
    }
    return sum
}

fun performMemoryIntensiveTask(): List<String> {
    val list = mutableListOf<String>()
    for (i in 1..100_000) {
        list.add("Item $i with some data: ${generateRandomString(100)}")
    }
    return list
}

fun generateRandomString(length: Int): String {
    val chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
    return (1..length).map { chars.random() }.joinToString("")
}
```

ã“ã‚“ãªæ„Ÿã˜ã§å„ç¨®æŒ‡æ¨™ãŒè¦‹ãˆã¦åˆ†æã§ãã‚‹
![](https://storage.googleapis.com/zenn-user-upload/729c4e6816e3-20250529.png)

# ãƒãƒã‚Šã©ã“ã‚

| ç¾è±¡ | åŸå› ã¨å¯¾å‡¦ |
| --- | --- |
| **`Profiler initialization failed`** | IAM æ¨©é™ä¸è¶³ï¼API ç„¡åŠ¹åŒ–ã‚’ç¢ºèª |
| ãƒ‡ãƒ¼ã‚¿ãŒæ¥ãªã„ | Cloud Run ãŒ 0 ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¾ã§ã‚¹ã‚±ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã™ã‚‹ã¨ Profiler ãŒå‹•ã‹ãªã„ â†’ **min-instances ã‚’ 1** ã«è¨­å®šã™ã‚‹ã‹ã€`test-profiler.sh` ãªã©ã®è² è·ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®šæœŸå®Ÿè¡Œã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¶­æŒã—ã‚µãƒ³ãƒ—ãƒ«ã‚’æºœã‚ã‚‹ |
| Flame Graph ãŒç²—ããªã‚‹ | concurrency ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (> 1) ã ã¨è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚µãƒ³ãƒ—ãƒ«ãŒæ··ã–ã‚‹ â†’ **concurrency ã‚’ 1** ã«ã—ã¦ 1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆ = 1 ã‚³ãƒ³ãƒ†ãƒŠã«ã™ã‚‹ |
| Profiler ãŒ `DEADLINE_EXCEEDED` | Serverless VPC Access çµŒç”±ã§ NAT ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (120 s) ã«å¼•ã£ã‹ã‹ã‚‹ â†’ `timeoutSeconds` ã‚’ 300 ãªã©ã¸æ‹¡å¼µã™ã‚‹ã‹ã€VPC ã‚³ãƒã‚¯ã‚¿ã‚’ä»‹ã•ãšå¤–éƒ¨é€šä¿¡ã™ã‚‹ |
| è‡ªä½œã‚¯ãƒ©ã‚¹ãŒå‡ºãªã„ | JIT æœªé©ç”¨ â†’ 30 ç§’ä»¥ä¸Šè² è·ï¼`-XX:TieredStopAtLevel=1` |
| ã‚³ã‚¹ãƒˆãŒå¿ƒé… | ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° 1 / 1000 secã€CPU 2 % æœªæº€ã€æ•°å††/æ—¥ãƒ¬ãƒ™ãƒ« |


# ã¾ã¨ã‚
Cloud Run ã§ Cloudâ€¯Profiler ã‚’å‹•ã‹ã™èª²é¡Œã¯ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã«ã‚ã‚Šãã†ã€‚ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ0å°ã«ãªã‚‹ãŸã³ã« Profiler Agent ã‚‚åœæ­¢ã—æŒ‡æ¨™ãŒæ¶ˆãˆã‚‹ã€‚ã“ã®ä½¿ã„ã«ãã«ã•ã‹ã‚‰å…¬å¼ã‚µãƒãƒ¼ãƒˆã®å¯¾è±¡å¤–ã¨ãªã£ã¦ã„ã‚‹ã¨æ¨æ¸¬ã™ã‚‹ã€‚

ãã‚Œã§ã‚‚ minâ€‘instances ã‚’1ã«è¨­å®šã—ã€çŸ­æ™‚é–“ã§ã‚‚è² è·ã‚’ç¶™ç¶šã—ã¦ä¸ãˆã‚Œã° FlameÂ Graph ã¯å–å¾—ã§ãã‚‹ã€‚ãªã®ã§é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨é€”ã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‚¾å‘æŠŠæ¡ã«ã¯ååˆ†ä½¿ãˆã‚‹ã€‚