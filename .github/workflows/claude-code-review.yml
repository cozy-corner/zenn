name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "articles/**/*.md"
      - "books/**/*.md"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            以下の原則に従って技術記事をレビューしてください:


            【結城浩「文章を書く心がけ」より】
            - 誰がその文章を読むのか：読者の技術レベルや前提知識を想定しているか
            - 読者は何を知っているか：既知から未知へ、段階的に説明しているか
            - 適切な例を示す：抽象的な説明だけでなく、具体例やコード例があるか
            - 読者と対話する気持ち：一方的な説明ではなく、読者の疑問を先回りしているか

            【結城浩「校正の実例」より】
            - 呼応の不一致：主語と述語、指示語と被指示語が正しく対応しているか
            - あいまいな表現：「これ」「それ」などの指示語が何を指すか明確か
            - 並列の乱れ：箇条書きや対比の構造が統一されているか
            - 冗長な文章：より簡潔に表現できる箇所はないか（辞書にない冗長表現）
            - わかりにくい説明：複雑すぎる文や説明を分割・整理できないか
            - 情報の欠落：読者が理解するために必要な情報が抜けていないか

            【riywo「質の高い技術文書を書く方法」より】
            - 記事の目的の明示：冒頭で「この記事の目的は〇〇です」「読むと△△が得られます」と明示されているか
            - 数値の具体性：パフォーマンスやリソースを「速い」「少ない」などの曖昧な表現ではなく、具体的な数値（「100msから10ms」など）で示しているか
            - 技術選択の比較：技術選定時に代替案と比較し、なぜその選択をしたかトレードオフも含めて説明しているか
            - 情報の構造的分離：詳細すぎる実装内容や補足情報をAppendixや別記事に分離し、本文の流れを保っているか

            【「GitLabに学ぶ パフォーマンスを最大化させるドキュメンテーション技術」より】
            - 1文1論点に絞る：構造的な問題を指摘
            - 1つの段落は1つのテーマに絞る
            - 能動態を用いる：主語と動詞を明確にする
            - ファクトとオピニオンを明確に分ける：事実と意見を区別する
            - 出典を記述してソースを明らかにする
            - 曖昧な表現を定量化：「かなり」「多くの」→「全体の8割」「97%」など具体的な数値や割合
            - 時間の曖昧さを避ける：「新しい」「現在は」→具体的な日付や版数
            - 略語の説明：初出時に正式名称を使用し、その後にカッコで略語を記載
            - 一貫した用語を用いる：同じ概念には同じ用語を使う

            ## レビューの投稿方法

            **重要: GitHub API を使ってインラインコメントを投稿してください**

            1. **diffの取得と解析**:
               - `gh pr diff <PR番号>` でdiffを取得
               - 各ファイルの変更箇所(hunk)と行番号を把握

            2. **インラインコメントの投稿**:
               GitHub API を使用して、`line`と`side`パラメータでインラインコメントを投稿します:
               ```bash
               gh api repos/$REPO/pulls/<PR番号>/reviews \
                 --method POST \
                 --field commit_id="<最新のcommit ID>" \
                 --field event="COMMENT" \
                 --field body="レビュー完了しました" \
                 --field 'comments[][path]=articles/example.md' \
                 --field 'comments[][line]=14' \
                 --field 'comments[][side]=RIGHT' \
                 --field 'comments[][body]=【一文が長すぎる】この文は135文字あります...'
               ```

            3. **line と side パラメータの使い方**:
               **重要**: `position`パラメータは非推奨です。代わりに`line`と`side`を使います。

               - **`line`**: ファイルの実際の行番号(1から始まる)
               - **`side`**: どちらのバージョンか
                 - `RIGHT`: 新しいバージョン(変更後・追加された行)
                 - `LEFT`: 古いバージョン(変更前・削除された行)

               **例1**: 変更後のファイルの14行目にコメント
               ```bash
               --field 'comments[][path]=articles/184bf3b88c9f2a.md'
               --field 'comments[][line]=14'
               --field 'comments[][side]=RIGHT'
               --field 'comments[][body]=【一文が長すぎる】...'
               ```

               **例2**: 複数行にまたがるコメント(14行目から16行目)
               ```bash
               --field 'comments[][path]=articles/example.md'
               --field 'comments[][start_line]=14'
               --field 'comments[][line]=16'
               --field 'comments[][side]=RIGHT'
               --field 'comments[][body]=この段落全体を見直してください'
               ```

               **注意**:
               - 新規ファイルの場合も既存ファイルの場合も、ファイルの行番号をそのまま使います
               - diffを解析してpositionを計算する必要はありません
               - コメントは変更された行(`+`で追加された行)にのみ投稿できます

            4. **観点の明記**: 各コメントの冒頭に、該当するチェック項目を【】で明記
               - 例: 【前提知識が不明確】【並列の乱れ】【ファクトとオピニオンの混在】【情報の欠落】【略語の説明不足】

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://docs.claude.com/en/docs/claude-code/cli-reference for available options
          # Allow gh commands needed for reviewing PRs (including API calls for inline comments)
          claude_args: '--allowedTools "Bash(gh pr view:*)" "Bash(gh pr diff:*)" "Bash(gh api:*)"'

